local INVENTORY_THRESHOLD = 16
local steps = 0

-- Trash blocks (vanilla + modded)
local trashBlocks = {
    ["minecraft:cobblestone"]=true,
    ["minecraft:dirt"]=true,
    ["minecraft:sand"]=true,
    ["minecraft:gravel"]=true,
    ["minecraft:stone"]=true,
    ["minecraft:marble"]=true,
    ["modname:cobbedstone"]=true,
    ["modname:granite"]=true
}

-- Dump trash if inventory is mostly full
function dumpTrash()
    for i=1,16 do
        turtle.select(i)
        local item = turtle.getItemDetail()
        if item and trashBlocks[item.name] then
            turtle.drop()
        end
    end
end

-- Deposit exactly 1 stack of coal and return
function depositCoal()
    turtle.turnLeft()
    turtle.turnLeft()
    for i=1,16 do
        turtle.select(i)
        local item = turtle.getItemDetail()
        if item and item.name == "minecraft:coal" then
            if item.count >= 64 then
                turtle.drop(64)
                break
            end
        end
    end
    turtle.turnLeft()
    turtle.turnLeft()
end

-- Move forward safely and dig blocks
function safeForward()
    while turtle.detect() do turtle.dig() end
    turtle.forward()
    steps = steps + 1
end

-- Mine in 2x2 tunnels for given length
function mine2x2(length)
    for l=1,length do
        for i=1,2 do
            turtle.digUp()
            turtle.digDown()
            safeForward()
            dumpTrash()
            -- Check if we have a full stack of coal
            for s=1,16 do
                local item = turtle.getItemDetail(s)
                if item and item.name == "minecraft:coal" and item.count >= 64 then
                    return true
                end
            end
        end
        turtle.turnRight()
        turtle.digUp()
        turtle.digDown()
        safeForward()
        turtle.turnLeft()
    end
    return false
end

-- Return to base using steps
function goHome()
    turtle.turnLeft()
    turtle.turnLeft()
    for i=1,steps do turtle.forward() end
    turtle.turnLeft()
    turtle.turnLeft()
    steps = 0
end

-- Main loop
while true do
    local fullStack = mine2x2(5)
    if fullStack then
        goHome()
        depositCoal()
    end
end
