local INVENTORY_THRESHOLD = 16
local STACK_TARGET = 64
local steps = 0

-- Trash blocks (vanilla + common modded)
local trashBlocks = {
    ["minecraft:cobblestone"]=true,
    ["minecraft:dirt"]=true,
    ["minecraft:sand"]=true,
    ["minecraft:gravel"]=true,
    ["minecraft:stone"]=true,
    ["minecraft:marble"]=true,
    ["appliedenergistics2:crushed_stone"]=true,
    ["thermal:cobblestone_variant"]=true
}

-- Dump all trash in inventory
function dumpTrash()
    for i=1,16 do
        turtle.select(i)
        local item = turtle.getItemDetail()
        if item and trashBlocks[item.name] then
            turtle.drop()
        end
    end
end

-- Deposit 1 full stack of coal and reset orientation
function depositCoal()
    turtle.turnLeft()
    turtle.turnLeft()
    for i=1,16 do
        turtle.select(i)
        local item = turtle.getItemDetail()
        if item and item.name == "minecraft:coal" and item.count >= STACK_TARGET then
            turtle.drop(STACK_TARGET)
            break
        end
    end
    turtle.turnLeft()
    turtle.turnLeft()
end

-- Move forward safely, dig obstacles
function safeForward()
    while turtle.detect() do turtle.dig() end
    turtle.forward()
    steps = steps + 1
end

-- Mine in 2x2 tunnel, return true if stack collected
function mine2x2(length)
    for l=1,length do
        for i=1,2 do
            turtle.digUp()
            turtle.digDown()
            safeForward()
            dumpTrash()
            -- Check for full coal stack
            for s=1,16 do
                local item = turtle.getItemDetail(s)
                if item and item.name == "minecraft:coal" and item.count >= STACK_TARGET then
                    return true
                end
            end
        end
        turtle.turnRight()
        turtle.digUp()
        turtle.digDown()
        safeForward()
        turtle.turnLeft()
    end
    return false
end

-- Return home using steps
function goHome()
    turtle.turnLeft()
    turtle.turnLeft()
    for i=1,steps do turtle.forward() end
    turtle.turnLeft()
    turtle.turnLeft()
    steps = 0
end

-- Main mining loop
while true do
    local fullStack = mine2x2(10)  -- Mine 10 iterations per run
    if fullStack then
        goHome()
        depositCoal()
    end
end
